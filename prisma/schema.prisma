generator client {
  provider   = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ===================================
// ENUMS
// ===================================
enum Role {
  admin
  user
}

enum MediaType {
  IMAGE
  VIDEO
}

enum AttributeType {
  TEXT // Texto simple
  NUMBER // Num√©rico
  BOOLEAN // S√≠/No
  SELECT // Lista de opciones (una)
  MULTISELECT // M√∫ltiples opciones
  COLOR // Selector de color
  DATE // Fecha
}

enum OptionType {
  TEXT // texto libre
  COLOR // selector de color con hex
  SIZE // talla predefinida
  SELECT // lista desplegable
  NUMBER // num√©rico con unidad
}

// ===================================
// CATEGOR√çAS (Jer√°rquicas)
// ===================================
model Category {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique
  description String? @db.Text

  // üå≥ Jerarqu√≠a (self-reference)
  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children Category[] @relation("CategoryHierarchy")

  // üé® SEO
  metaTitle       String?
  metaDescription String?  @db.Text
  metaKeywords    String[] @default([])

  // üìä Ordenamiento y visibilidad
  order      Int     @default(0)
  isActive   Boolean @default(true) // false = no accesible
  isHidden   Boolean @default(false) // true = no en men√∫s, pero accesible por URL
  isFeatured Boolean @default(false) // destacada en home

  // üñºÔ∏è Media (im√°genes/videos)
  media CategoryMedia[]

  // üóëÔ∏è Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîó Relaciones
  products ProductCategory[]

  @@index([slug])
  @@index([parentId])
  @@index([isActive, isHidden, deletedAt])
  @@index([isFeatured])
  @@index([order])
  @@map("categories")
}

model CategoryMedia {
  id         String    @id @default(uuid())
  categoryId String
  type       MediaType
  url        String
  order      Int       @default(0)
  isMain     Boolean   @default(false)
  alt        String?

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([order])
  @@map("category_media")
}

// ===================================
// MARCAS/TAXONOM√çAS (Planas)
// ===================================
model Brand {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique
  description String? @db.Text

  // üè∑Ô∏è Tipo de taxonom√≠a (extensible)
  type String @default("brand") // "brand", "collection", "designer", "line"

  // üé® SEO
  metaTitle       String?
  metaDescription String?  @db.Text
  metaKeywords    String[] @default([])

  // üìä Ordenamiento y visibilidad
  order      Int     @default(0)
  isActive   Boolean @default(true)
  isHidden   Boolean @default(false)
  isFeatured Boolean @default(false)

  // üñºÔ∏è Media
  media BrandMedia[]

  // üóëÔ∏è Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîó Relaciones
  products ProductBrand[]

  @@index([slug])
  @@index([type])
  @@index([isActive, isHidden, deletedAt])
  @@index([isFeatured])
  @@index([order])
  @@map("brands")
}

model BrandMedia {
  id      String    @id @default(uuid())
  brandId String
  type    MediaType
  url     String
  order   Int       @default(0)
  isMain  Boolean   @default(false)
  alt     String?

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([order])
  @@map("brand_media")
}

// ===================================
// OPCIONES DE VARIANTE (Shopify Style)
// ===================================
model VariantOption {
  id   String     @id @default(uuid())
  name String // "Color", "Talla", "Almacenamiento", "RAM"
  slug String     @unique
  type OptionType @default(TEXT)

  // üìù Ayuda y placeholder
  description String?
  placeholder String? // "Ej: Rojo, Azul, Verde"

  // üìä Orden de presentaci√≥n global
  position Int @default(0)

  // ‚öôÔ∏è Configuraci√≥n
  isRequired   Boolean @default(false) // si es obligatorio definirlo
  isFilterable Boolean @default(true) // si aparece en filtros de b√∫squeda

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîó Relaciones
  productOptions ProductVariantOption[]
  variantValues  VariantOptionValue[]

  @@index([slug])
  @@index([position])
  @@index([isFilterable])
  @@map("variant_options")
}

// ===================================
// OPCIONES DE VARIANTE POR PRODUCTO
// ===================================
model ProductVariantOption {
  id        String @id @default(uuid())
  productId String
  optionId  String

  // üìä Orden de presentaci√≥n en este producto
  position Int @default(0)

  // üìã Valores posibles para este producto espec√≠fico
  // Ejemplo: ["Rojo", "Azul", "Verde"] para color
  values String[] @default([])

  product Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  option  VariantOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([productId, optionId])
  @@index([productId])
  @@index([optionId])
  @@index([position])
  @@map("product_variant_options")
}

// ===================================
// ATRIBUTOS DESCRIPTIVOS (no generan variantes)
// ===================================
model AttributeDefinition {
  id   String        @id @default(uuid())
  name String // "Material", "Garant√≠a", "Peso"
  slug String        @unique
  type AttributeType

  // üìã Para SELECT/MULTISELECT
  options String[] @default([])

  // ‚öôÔ∏è Validaciones
  isRequired   Boolean @default(false)
  isFilterable Boolean @default(true)

  // üìä Ordenamiento y agrupaci√≥n
  order Int     @default(0)
  group String? // "Caracter√≠sticas", "Especificaciones", "Cuidado"

  // üìù Ayuda
  description String?
  unit        String? // "kg", "cm", "meses"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîó Relaciones
  productAttributes ProductAttribute[]

  @@index([slug])
  @@index([type])
  @@index([isFilterable])
  @@index([group, order])
  @@map("attribute_definitions")
}

model ProductAttribute {
  id          String @id @default(uuid())
  productId   String
  attributeId String

  // üíæ Valor (uno de estos seg√∫n el tipo)
  valueText   String?
  valueNumber Float?
  valueBool   Boolean?
  valueSelect String?
  valueMulti  String[]  @default([])
  valueColor  String? // hex color
  valueDate   DateTime?

  product   Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  attribute AttributeDefinition @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([productId, attributeId])
  @@index([productId])
  @@index([attributeId])
  @@index([valueSelect]) // para filtros
  @@index([valueNumber]) // para rangos
  @@map("product_attributes")
}

// ===================================
// PRODUCTO
// ===================================
model Product {
  id          String @id @default(uuid())
  title       String @db.VarChar(255)
  description String @db.Text
  slug        String @unique

  price Float @default(0) // precio base

  // üè∑Ô∏è Tags para b√∫squeda
  tags String[] @default([])

  // üé® SEO
  metaTitle       String?  @db.VarChar(255)
  metaDescription String?  @db.Text
  metaKeywords    String[] @default([])

  // üìä Visibilidad y estado
  isActive   Boolean @default(true)
  isHidden   Boolean @default(false)
  isFeatured Boolean @default(false)

  // üóëÔ∏è Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîó Relaciones many-to-many
  categories ProductCategory[]
  brands     ProductBrand[]

  // üîó Atributos descriptivos (no generan variantes)
  attributes ProductAttribute[]

  // üîó Opciones de variante (definen qu√© opciones tiene)
  variantOptions ProductVariantOption[]

  // üîó Variantes reales (combinaciones de opciones)
  variants ProductVariant[]

  // üîó Im√°genes generales
  images ProductImage[]

  // üîó Relaciones existentes
  OrderItem OrderItem[]
  Favorite  Favorite[]

  @@index([slug])
  @@index([isActive, isHidden, deletedAt])
  @@index([isFeatured])
  @@index([createdAt])
  @@index([price])
  @@index([title]) // para b√∫squedas
  @@map("products")
}

// ===================================
// VARIANTE DE PRODUCTO (SKU √∫nico)
// ===================================
model ProductVariant {
  id        String @id @default(uuid())
  productId String

  // üí∞ Precio espec√≠fico (null = usar precio base del producto)
  price Float?

  // üì¶ Stock
  inStock Int @default(0)

  // üè∑Ô∏è C√≥digos
  sku     String? @unique
  barcode String?

  // üìè Peso y dimensiones (para shipping)
  weight Float? // en gramos
  length Float? // en cm
  width  Float? // en cm
  height Float? // en cm

  // ‚öôÔ∏è Estado
  isActive Boolean @default(true)

  // üóëÔ∏è Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üîó Relaciones
  product      Product              @relation(fields: [productId], references: [id], onDelete: Cascade)
  optionValues VariantOptionValue[] // valores de opciones (Color: Rojo, Talla: M)
  images       ProductImage[] // im√°genes espec√≠ficas de esta variante
  orderItems   OrderItem[]

  // ‚ö° √çNDICES OPTIMIZADOS
  @@index([productId, inStock, isActive]) // filtrar disponibles
  @@index([productId, isActive])
  @@index([sku])
  @@index([price])
  @@index([inStock])
  @@index([barcode])
  @@map("product_variants")
}

// ===================================
// VALORES DE OPCI√ìN POR VARIANTE
// ===================================
model VariantOptionValue {
  id        String @id @default(uuid())
  variantId String
  optionId  String
  value     String // "Rojo", "M", "128GB", etc.

  option         VariantOption  @relation(fields: [optionId], references: [id], onDelete: Cascade)
  productVariant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  // ‚ö° √çNDICES CR√çTICOS PARA PERFORMANCE
  @@unique([variantId, optionId]) // una variante solo puede tener un valor por opci√≥n
  @@index([variantId]) // join r√°pido
  @@index([optionId, value]) // filtros (ej: color = "Rojo")
  @@index([value]) // b√∫squedas generales
  @@map("variant_option_values")
}

// ===================================
// RELACI√ìN PRODUCTO-CATEGOR√çA
// ===================================
model ProductCategory {
  id         String @id @default(uuid())
  productId  String
  categoryId String

  isPrimary Boolean @default(false) // categor√≠a principal
  order     Int     @default(0)

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
  @@index([isPrimary])
  @@map("product_categories")
}

// ===================================
// RELACI√ìN PRODUCTO-MARCA
// ===================================
model ProductBrand {
  id        String @id @default(uuid())
  productId String
  brandId   String

  isPrimary Boolean @default(false)
  order     Int     @default(0)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  brand   Brand   @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([productId, brandId])
  @@index([productId])
  @@index([brandId])
  @@index([isPrimary])
  @@map("product_brands")
}

// ===================================
// IM√ÅGENES DE PRODUCTO/VARIANTE
// ===================================
model ProductImage {
  id    Int     @id @default(autoincrement())
  url   String
  alt   String?
  order Int     @default(0)

  productId String?
  variantId String?

  product Product?        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([variantId])
  @@index([order])
  @@map("product_images")
}

// ===================================
// FAVORITOS
// ===================================
model Favorite {
  id        String @id @default(uuid())
  userId    String
  productId String

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("favorites")
}

// ===================================
// USUARIOS Y AUTENTICACI√ìN
// ===================================
model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  password      String?
  role          Role      @default(user)
  image         String?

  address UserAddress?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  Order     Order[]
  Favorite  Favorite[]
  Account   Account[]
  Session   Session[]
  SearchLog SearchLog[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ===================================
// B√öSQUEDAS (Analytics)
// ===================================
model SearchLog {
  id           String   @id @default(uuid())
  term         String
  resultsCount Int
  userId       String?
  timestamp    DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([term])
  @@index([timestamp])
  @@index([userId])
  @@index([term, timestamp]) // para trending
  @@map("search_logs")
}

// ===================================
// DIRECCIONES Y PA√çSES
// ===================================
model Country {
  id   String @id
  name String

  UserAddress  UserAddress[]
  OrderAddress OrderAddress[]

  @@map("countries")
}

model UserAddress {
  id         String  @id @default(uuid())
  firstName  String
  lastName   String
  address    String
  address2   String?
  postalCode String
  phone      String
  city       String

  country   Country @relation(fields: [countryId], references: [id])
  countryId String

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  @@index([userId])
  @@index([countryId])
  @@map("user_addresses")
}

// ===================================
// √ìRDENES
// ===================================
model Order {
  id           String    @id @default(uuid())
  subTotal     Float
  tax          Float
  total        Float
  itemsInOrder Int
  isPaid       Boolean   @default(false)
  paidAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  userId String

  OrderItem    OrderItem[]
  OrderAddress OrderAddress?

  transactionId String?

  @@index([userId])
  @@index([isPaid])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id       String @id @default(uuid())
  quantity Int
  price    Float

  // Snapshot de la variante al momento de compra
  variantSnapshot Json // { color: "Rojo", size: "M", sku: "..." }

  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId String

  product   Product @relation(fields: [productId], references: [id])
  productId String

  // Referencia a la variante (puede ser null si se elimin√≥)
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  variantId String?

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
  @@map("order_items")
}

model OrderAddress {
  id         String  @id @default(uuid())
  firstName  String
  lastName   String
  address    String
  address2   String?
  postalCode String
  city       String
  phone      String

  country   Country @relation(fields: [countryId], references: [id])
  countryId String

  Order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId String @unique

  @@index([orderId])
  @@map("order_addresses")
}
